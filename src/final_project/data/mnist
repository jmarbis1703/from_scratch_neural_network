from __future__ import annotations
from dataclasses import dataclass
import numpy as np
from sklearn.datasets import fetch_openml
from sklearn.model_selection import train_test_split

@dataclass
class MNISTData:
    X_train: np.ndarray
    X_val: np.ndarray
    X_test: np.ndarray
    y_train: np.ndarray
    y_val: np.ndarray
    y_test: np.ndarray

def load_mnist(test_size: float = 0.2, seed: int = 42) -> MNISTData:
    """
    Fetches MNIST, normalizes to [0,1], and performs stratified splits.
    """
    print("Downloading MNIST (this may take a moment)...")
    # Fetch data (cached by sklearn automatically after first run)
    X, y = fetch_openml("mnist_784", version=1, return_X_y=True, as_frame=False, parser='auto')
    
    X = X.astype(np.float32) / 255.0
    y = y.astype(np.int64)

    X_tr, X_te, y_tr, y_te = train_test_split(X, y, test_size=test_size, random_state=seed, stratify=y)
    # Stratified Split: Train/Val
    X_tr, X_va, y_tr, y_va = train_test_split(X_tr, y_tr, test_size=0.2, random_state=seed, stratify=y_tr)

    return MNISTData(X_tr, X_va, X_te, y_tr, y_va, y_te)
